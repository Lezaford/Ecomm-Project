<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="style.css">
    <meta charset="utf-8" />
    <title>Part – Appliance Parts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Header (shared) -->
    <header>
      <a href="index.html" aria-label="Home">Appliance Parts</a>
      <form id="header-search" role="search" aria-label="Search">
        <input
          id="header-search-input"
          type="search"
          placeholder="Enter Model or Part Number"
          autocomplete="off"
          required
        />
        <button type="submit">Search</button>
      </form>
      <nav>
        <a id="cart-link" href="cart.html" aria-label="Cart">
          Cart (<span id="cart-count">0</span>)
        </a>
      </nav>
    </header>

    <main>
      <h1 id="part-title">Part</h1>

      <section class="panel">
        <table id="part-table">
          <tbody>
            <tr>
              <th scope="row">Name</th>
              <td id="p-name"></td>
            </tr>
            <tr>
              <th scope="row">Part #</th>
              <td id="p-number"></td>
            </tr>
            <tr>
              <th scope="row">Manufacturer</th>
              <td id="p-mfg"></td>
            </tr>
            <tr>
              <th scope="row">Product Status</th>
              <td><span id="p-status" class="badge"></span></td>
            </tr>
            <tr>
              <th scope="row">Inventory</th>
              <td id="p-inventory"></td>
            </tr>
            <tr>
              <th scope="row">Price</th>
              <td id="p-price"></td>
            </tr>
            <tr>
              <th scope="row">Description</th>
              <td id="p-desc"></td>
            </tr>
          </tbody>
        </table>
      </section>

      <section class="panel">
        <h2>Add to Cart</h2>
        <label for="qty" class="muted">Quantity</label>
        <div>
          <input id="qty" type="number" min="1" step="1" value="1" />
          <button id="add-to-cart">Add to Cart</button>
        </div>
        <p id="purchase-note" class="muted"></p>
      </section>

      <div id="loading" class="panel">Loading…</div>
      <div id="error" class="panel" hidden></div>
    </main>

    <!-- CSV-backed data + search/router -->
    <script src="search.js"></script>
    <script>
      // ----- Header wiring -----
      (function initHeader(){
        // cart count
        try {
          const count = Number(localStorage.getItem("cartCount") || "0");
          document.getElementById("cart-count").textContent = String(count);
        } catch (e) {}
        // search submit
        const form = document.getElementById("header-search");
        const input = document.getElementById("header-search-input");
        form.addEventListener("submit", function(e){
          e.preventDefault();
          const q = (input.value || "").trim();
          if (q) runSearch(q);
        });
      })();

      // ----- Small helpers -----
      function qp(name){ return new URLSearchParams(location.search).get(name) || ""; }
      function setText(id, v){ const el = document.getElementById(id); if (el) el.textContent = v; }
      function setHidden(id, h){ const el = document.getElementById(id); if (el) el.hidden = !!h; }
      function mapStatus(s){
        const t = String(s || "").toLowerCase();
        if (t === "in_stock")     return { text: "In Stock",     cls: "badge in_stock" };
        if (t === "backordered")  return { text: "Backordered",  cls: "badge backordered" };
        if (t === "out_of_stock") return { text: "Out of Stock", cls: "badge out_of_stock" };
        if (t === "discontinued") return { text: "Discontinued", cls: "badge discontinued" };
        return { text: s || "", cls: "badge" };
      }
      function formatUSD(n){ return (typeof n === "number" && !isNaN(n)) ? ("$" + n.toFixed(2)) : ""; }

      // ----- Cart helpers (localStorage) -----
      function getCart(){ try { return JSON.parse(localStorage.getItem("cart") || "[]"); } catch(e){ return []; } }
      function setCart(cart){
        localStorage.setItem("cart", JSON.stringify(cart));
        const count = cart.reduce((s, it) => s + (Number(it.qty) || 0), 0);
        localStorage.setItem("cartCount", String(count));
        setText("cart-count", String(count));
      }
      function addToCart(id, qty){
        const cart = getCart();
        const line = cart.find(x => x.id === id);
        if (line) line.qty = (Number(line.qty) || 0) + qty;
        else cart.push({ id, qty });
        setCart(cart);
      }

      // ----- Page loader (reads from parts.csv via DB) -----
      (async function loadPartPage(){
        const idOrNumber = qp("id");
        const showError = (msg) => {
          setText("error", msg);
          setHidden("error", false);
          setHidden("loading", true);
        };

        try {
          if (!idOrNumber) { showError("No part specified."); return; }

          const part = await DB.getPartByIdOrNumber(idOrNumber);
          if (!part) { showError("Part not found."); return; }

          const name  = part.name || part.description || "";
          const num   = part.number || part.id;
          const mfg   = part.manufacturer || "";
          const inv   = (typeof part.inventory === "number") ? part.inventory : (Number(part.inventory) || 0);
          const stat  = mapStatus(part.productStatus);
          const price = part.price;

          setText("part-title", name ? ("Part: " + name) : ("Part " + num));
          setText("p-name", name);
          setText("p-number", num);
          setText("p-mfg", mfg);
          setText("p-inventory", String(inv));
          setText("p-desc", part.description || "");
          setText("p-price", formatUSD(price));
          const sEl = document.getElementById("p-status");
          sEl.textContent = stat.text;
          sEl.className = stat.cls;

          // Purchase rules for MVP: allow add-to-cart only when in stock and inv > 0
          const purchasable = (String(part.productStatus || "").toLowerCase() === "in_stock" && inv > 0);
          const qtyEl = document.getElementById("qty");
          const btnEl = document.getElementById("add-to-cart");
          qtyEl.disabled = !purchasable;
          btnEl.disabled = !purchasable;
          if (purchasable) {
            qtyEl.max = String(inv);
            setText("purchase-note", "");
          } else {
            let note = "This item is not available for purchase.";
            const ps = String(part.productStatus || "").toLowerCase();
            if (ps === "discontinued") note = "This item is discontinued.";
            else if (ps === "backordered") note = "Backorder purchasing not enabled yet.";
            else if (ps === "out_of_stock") note = "This item is currently out of stock.";
            setText("purchase-note", note);
          }

          btnEl.addEventListener("click", function(){
            let q = Math.max(1, parseInt(qtyEl.value, 10) || 1);
            if (purchasable && inv) q = Math.min(q, inv);
            addToCart(part.id || num, q);
            alert("Added to cart: " + num + " × " + q);
          });

          setHidden("loading", true);
        } catch (e) {
          showError("Failed to load part data.");
        }
      })();
    </script>
  </body>
</html>
