<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="style.css">
    <meta charset="utf-8" />
    <title>Model Schematics – Appliance Parts</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <!-- Header (shared) -->
    <header>
      <a href="index.html" aria-label="Home">Appliance Parts</a>
      <form id="header-search" role="search" aria-label="Search">
        <input
          id="header-search-input"
          type="search"
          placeholder="Enter Model or Part Number"
          autocomplete="off"
          required
        />
        <button type="submit">Search</button>
      </form>
      <nav>
        <a id="cart-link" href="cart.html" aria-label="Cart">
          Cart (<span id="cart-count">0</span>)
        </a>
      </nav>
    </header>

    <main>
      <h1 id="model-title">Model Schematics</h1>

      <section class="panel">
        <!-- simple container; your CSS can style as a grid if desired -->
        <div id="schem-grid"></div>
      </section>

      <div id="loading" class="panel">Loading…</div>
      <div id="error" class="panel" hidden></div>
    </main>

    <!-- CSV-backed data & router -->
    <script src="search.js"></script>
    <script>
      /* ---------- Header wiring ---------- */
      (function initHeader(){
        try {
          const count = Number(localStorage.getItem("cartCount") || "0");
          document.getElementById("cart-count").textContent = String(count);
        } catch (e) {}
        document.getElementById("header-search").addEventListener("submit", function(e){
          e.preventDefault();
          const q = (document.getElementById("header-search-input").value || "").trim();
          if (q) runSearch(q);
        });
      })();

      /* ---------- Utilities ---------- */
      const qp = (k) => new URLSearchParams(location.search).get(k) || "";
      const setText = (id, v) => { const el = document.getElementById(id); if (el) el.textContent = v; };
      const setHidden = (id, h) => { const el = document.getElementById(id); if (el) el.hidden = !!h; };
      const pad2 = (n) => String(Math.max(0, Number(n)||0)).padStart(2, "0");

      /* ---------- Page loader ----------
         - Reads ?id=<modelID>
         - Collects schematics where schematics.csv modelID == <modelID>
         - Sorts by 'order' (then by id)
         - Renders images from /schematics/<modelID>-<NN>.webp (NN = 01,02,...)
      ----------------------------------- */
      (async function loadModelSchematics(){
        const modelId = qp("id") || qp("modelId");
        const fail = (msg) => { setText("error", msg); setHidden("error", false); setHidden("loading", true); };

        try {
          if (!modelId) return fail("No model specified.");

          // Pull schematics for this model (exact match first)
          let list = await DB.listSchematicsByModelId(modelId);

          // Fallback: case-insensitive scan if none found
          if (!list.length) {
            const db = await DB.load();
            const k = String(modelId).trim().toLowerCase();
            list = db.schematics.filter(s => String(s.modelId || "").trim().toLowerCase() === k);
          }

          if (!list.length) {
            setText("model-title", "Model " + modelId);
            return fail("No schematics found for this model.");
          }

          // Sort by explicit 'order' then by id
          list.sort((a,b) => (a.order - b.order) || a.id.localeCompare(b.id));

          // Title
          setText("model-title", "Model " + modelId);

          // Render
          const grid = document.getElementById("schem-grid");
          grid.innerHTML = "";

          list.forEach((s, idx) => {
            const orderNo = (s.order && s.order > 0) ? s.order : (idx + 1);
            // Build the exact image path: /schematics/<modelID>-<NN>.webp
            const imgSrc = "/schematics/" + modelId + "-" + pad2(orderNo) + ".webp";

            // Card container (plain div works fine even without grid CSS)
            const card = document.createElement("div");
            card.className = "schem-card";

            // Clickable image to schematic detail
            const link = document.createElement("a");
            link.href = "schematic.html?id=" + encodeURIComponent(s.id);
            link.title = s.name || s.id;

            const img = document.createElement("img");
            img.src = imgSrc;
            img.alt = s.name ? ("Schematic – " + s.name) : s.id;
            link.appendChild(img);

            const caption = document.createElement("div");
            caption.className = "schem-caption";
            caption.textContent = pad2(orderNo) + " – " + (s.name || s.id);

            card.appendChild(link);
            card.appendChild(caption);
            grid.appendChild(card);
          });

          setHidden("loading", true);
        } catch (e) {
          console.error(e);
          fail("Failed to load schematics.");
        }
      })();
    </script>
  </body>
</html>
