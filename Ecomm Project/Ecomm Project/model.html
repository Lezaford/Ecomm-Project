<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="style.css" />
    <meta charset="utf-8" />
    <title>Model – Schematics</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <!-- Page-local styles just for the tiles grid -->
    <style>
      .tiles-wrap{ margin-top: 8px; }
      .tiles{
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
        gap: 12px;
        align-items: stretch;
      }
      .tile{
        display: flex;
        flex-direction: column;
        border: 1px solid var(--border);
        border-radius: 10px;
        background: #fff;
      }
      .tile a{ text-decoration: none; color: inherit; display:flex; flex-direction:column; height:100%; }
      .tile-img{
        width: 100%;
        aspect-ratio: 4 / 3;
        object-fit: contain;     /* show whole schematic thumbnail */
        display: block;
        background: #fafafa;
        border-bottom: 1px solid var(--border);
      }
      .tile-body{
        padding: 8px;
        display:flex;
        flex-direction:column;
        gap: 4px;
        flex: 1 1 auto;
      }
      .tile-title{ font-weight: 700; font-size: 14px; }
      .tile-sub{ font-size: 12px; color: #6b7280; }
      .empty{ padding: 16px; border:1px dashed var(--border); border-radius:10px; background:#fff; }
    </style>
  </head>
  <body>
    <header>
      <div class="header-inner">
        <a class="header-logo" href="index.html" aria-label="Home">
          <img src="/logo/logo.png" alt="Appliance Parts Home" />
        </a>
        <form id="header-search" role="search" aria-label="Search">
          <input id="header-search-input" type="search" placeholder="Enter Model or Part Number" autocomplete="off" required />
          <button type="submit">Search</button>
        </form>
        <a id="cart-link" class="header-cart" href="cart.html" aria-label="Cart">
          <svg class="cart-icon" viewBox="0 0 24 24" aria-hidden="true">
            <path d="M7 18a2 2 0 1 0 0 4 2 2 0 0 0 0-4Zm10 0a2 2 0 1 0 .001 3.999A2 2 0 0 0 17 18ZM5.1 5h-.8a1 1 0 1 1 0-2h2.1c.46 0 .86.31.97.75L8 6h11a1 1 0 0 1 .96 1.27l-1.8 6.3A2 2 0 0 1 16.27 15H9.12a2 2 0 0 1-1.94-1.52L5.1 5Zm3.2 9h7.97a.5.5 0 0 0 .48-.36L18.3 8H8.56l1.74 6.02a.5.5 0 0 0 .5.38Z"/>
          </svg>
          <span id="cart-count" aria-live="polite">0</span>
        </a>
      </div>
    </header>

    <main>
      <h1 id="page-title">Model</h1>
      <h2 id="model-sub" class="muted"></h2>

      <section id="content" class="tiles-wrap">
        <div id="loading" class="panel">Loading…</div>
        <div id="error" class="panel" hidden></div>
        <div id="tiles" class="tiles" hidden></div>
        <div id="empty" class="empty" hidden>No schematics found for this model.</div>
      </section>
    </main>

    <!-- Data & search -->
    <script src="search.js"></script>
    <script>
      /* ---------- Header wiring ---------- */
      (function initHeader(){
        try {
          const count = Number(localStorage.getItem("cartCount") || "0");
          document.getElementById("cart-count").textContent = String(count);
        } catch (e) {}
        const form = document.getElementById("header-search");
        if (form){
          form.addEventListener("submit", function(e){
            e.preventDefault();
            const q = (document.getElementById("header-search-input").value || "").trim();
            if (q) runSearch(q);
          });
        }
      })();

      /* ---------- Utils ---------- */
      const qp = (k) => new URLSearchParams(location.search).get(k) || "";
      const setText = (id, v) => { const el=document.getElementById(id); if (el) el.textContent=v; };
      const show = (id, doShow=true) => { const el=document.getElementById(id); if (el) el.hidden=!doShow; };

      function buildSrcCandidates(stem){
        // Prefer PNG tiles; fall back to webp, then jpg
        return [
          `/schematics/${stem}.png`,
          `/schematics/${stem}.webp`,
          `/schematics/${stem}.jpg`
        ];
      }

      function attachProgressiveSrc(imgEl, stem){
        const candidates = buildSrcCandidates(stem);
        let i = 0;
        function next(){
          if (i < candidates.length){
            imgEl.onerror = next;
            imgEl.src = candidates[i++];
          }
        }
        next();
      }

      /* ---------- Page loader ---------- */
      (async function loadModel(){
        const modelId = qp("id");
        const fail = (msg) => { setText("error", msg); show("error", true); show("loading", false); };

        try{
          await (window.DB && DB.init ? DB.init() : Promise.resolve());

          if (!modelId) return fail("No model specified.");

          const model = await DB.getModelById(modelId);
          const modelLabel = model ? (model.modelNumber || model.id || modelId) : modelId;
          setText("page-title", `Model ${modelLabel}`);
          setText("model-sub", model && model.brand ? `${model.brand}` : "");

          const list = await DB.listSchematicsForModel(modelLabel);
          show("loading", false);

          if (!list || list.length === 0){
            show("empty", true);
            return;
          }

          const tiles = document.getElementById("tiles");
          tiles.innerHTML = "";

          list.forEach((s, idx) => {
            const stem = (s.image || s.id || "").trim();
            const a = document.createElement("a");
            a.href = "schematic.html?id=" + encodeURIComponent(s.id);
            a.setAttribute("aria-label", (s.name || s.id) + " schematic");
            a.title = s.name || s.id;

            const card = document.createElement("div");
            card.className = "tile";

            const img = document.createElement("img");
            img.className = "tile-img";
            img.loading = "lazy";
            img.alt = s.name ? (`${s.name} – ${modelLabel}`) : (`Schematic ${s.id}`);
            attachProgressiveSrc(img, stem);

            const body = document.createElement("div");
            body.className = "tile-body";

            const ttl = document.createElement("div");
            ttl.className = "tile-title";
            ttl.textContent = s.name || `Schematic ${idx+1}`;

            const sub = document.createElement("div");
            sub.className = "tile-sub";
            sub.textContent = s.id;

            body.appendChild(ttl);
            body.appendChild(sub);

            a.appendChild(img);
            a.appendChild(body);
            card.appendChild(a);
            tiles.appendChild(card);
          });

          show("tiles", true);
        } catch (e){
          console.error(e);
          fail("Failed to load schematics for this model.");
        }
      })();
    </script>
  </body>
</html>
